{支撑压力系统交易
作者：CLAUDE
版本：1.4
日期：2024-03-21
功能：支撑压力线交易 + 成交量 + 均线系统
}

{参数定义}
N1:=5;    {短期周期}
N2:=10;   {中期周期}
N3:=20;   {中长期周期}
N4:=50;   {长期周期}

{基础数据}
TY:=H;

{短期支撑压力}
A1:=REF(TY,N1)=HHV(TY,2*N1+1);
B1:=FILTER(A1,N1);
C1:=BACKSET(B1,N1+1);
HD1:=FILTER(C1,N1);

A2:=REF(TY,N1)=LLV(TY,2*N1+1);
B2:=FILTER(A2,N1);
C2:=BACKSET(B2,N1+1);
LD1:=FILTER(C2,N1);

{中期支撑压力}
A3:=REF(TY,N2)=HHV(TY,2*N2+1);
B3:=FILTER(A3,N2);
C3:=BACKSET(B3,N2+1);
HD2:=FILTER(C3,N2);

A4:=REF(TY,N2)=LLV(TY,2*N2+1);
B4:=FILTER(A4,N2);
C4:=BACKSET(B4,N2+1);
LD2:=FILTER(C4,N2);

{中长期支撑压力}
A5:=REF(TY,N3)=HHV(TY,2*N3+1);
B5:=FILTER(A5,N3);
C5:=BACKSET(B5,N3+1);
HD3:=FILTER(C5,N3);

A6:=REF(TY,N3)=LLV(TY,2*N3+1);
B6:=FILTER(A6,N3);
C6:=BACKSET(B6,N3+1);
LD3:=FILTER(C6,N3);

{长期支撑压力}
A7:=REF(TY,N4)=HHV(TY,2*N4+1);
B7:=FILTER(A7,N4);
C7:=BACKSET(B7,N4+1);
HD4:=FILTER(C7,N4);

A8:=REF(TY,N4)=LLV(TY,2*N4+1);
B8:=FILTER(A8,N4);
C8:=BACKSET(B8,N4+1);
LD4:=FILTER(C8,N4);

{支撑压力线}
SUP1:DRAWLINE(LD1,L,LD1,L,1),COLORCYAN,LINETHICK1;
RES1:DRAWLINE(HD1,H,HD1,H,1),COLOR8000F0,LINETHICK1;

SUP2:DRAWLINE(LD2,L,LD2,L,1),COLORCYAN,LINETHICK2;
RES2:DRAWLINE(HD2,H,HD2,H,1),COLOR8000F0,LINETHICK2;

SUP3:DRAWLINE(LD3,L,LD3,L,1),COLORCYAN,LINETHICK3;
RES3:DRAWLINE(HD3,H,HD3,H,1),COLOR8000F0,LINETHICK3;

SUP4:DRAWLINE(LD4,L,LD4,L,1),COLORCYAN,LINETHICK4;
RES4:DRAWLINE(HD4,H,HD4,H,1),COLOR8000F0,LINETHICK4;

{支撑压力强度}
SUPS:=(LD1+LD2+LD3+LD4)/4*100,COLORWHITE;
RESS:=(HD1+HD2+HD3+HD4)/4*100,COLORWHITE;

{交易信号}
S_CROSS:=CROSS(SUPS,RESS);    {支撑上穿}
S_DEAD:=CROSS(RESS,SUPS);     {压力上穿}

P_BREAK_UP:=C>REF(C,1) AND L>LD1 AND L>LD2;   {突破支撑}
P_BREAK_DN:=C<REF(C,1) AND H<HD1 AND H<HD2;   {跌破压力}

BULL:=LD1>LD2 AND LD2>LD3;    {多头排列}
BEAR:=HD1<HD2 AND HD2<HD3;    {空头排列}

SUP_RATE:=(C-LD1)/LD1*100;    {支撑距离}
RES_RATE:=(HD1-C)/HD1*100;    {压力距离}

{成交量系统}
VOL_MA5:=MA(VOL,5);   {5日成交量均线}
VOL_MA10:=MA(VOL,10); {10日成交量均线}
VOL_MA20:=MA(VOL,20); {20日成交量均线}

{成交量条件}
VOL_COND1:=VOL>VOL_MA5;   {量能放大}
VOL_COND2:=VOL>VOL_MA20;  {量能强势}
VOL_GOOD:=VOL_COND1 AND VOL_COND2; {成交量条件满足}

{均线系统}
MA5:=MA(C,5);
MA10:=MA(C,10);
MA20:=MA(C,20);
MA60:=MA(C,60);

{均线条件}
MA_COND1:=MA5>MA10;   {5日线上穿10日线}
MA_COND2:=MA10>MA20;  {10日线在20日线上方}
MA_COND3:=MA20>MA60;  {20日线在60日线上方}
MA_GOOD:=MA_COND1 AND MA_COND2 AND MA_COND3; {均线系统良好}

{买卖信号基础}
BASE_BUY:=S_CROSS AND         {支撑突破}
    (P_BREAK_UP OR           {价突破}
    (BULL AND               {多头排列}
    SUP_RATE<=2));         {靠近支撑}

{买点评级 - 简化版本}
LEVEL_HIGH:=BASE_BUY AND VOL_GOOD AND MA_GOOD;     {三条件都满足}
LEVEL_MID:=BASE_BUY AND (VOL_GOOD OR MA_GOOD) AND LEVEL_HIGH=0;  {满足一个辅助条件}
LEVEL_LOW:=BASE_BUY AND VOL_GOOD=0 AND MA_GOOD=0;  {只满足基础条件}

{买点显示}
BUYPOINT:=LEVEL_HIGH OR LEVEL_MID OR LEVEL_LOW;  {任意级别买点}

{卖出信号}
SELLPOINT:=S_DEAD OR         {压力突破}
    (P_BREAK_DN AND         {价跌破}
    BEAR AND                {空头排列}
    RES_RATE<=2);          {靠近压力}

{信号显示升级}
DRAWICON(LEVEL_HIGH,L*0.99,1),COLORRED;      {高级别买点}
DRAWICON(LEVEL_MID,L*0.99,11),COLORYELLOW;   {中级别买点}
DRAWICON(LEVEL_LOW,L*0.99,38),COLORWHITE;    {低级别买点}
DRAWICON(SELLPOINT,H*1.01,2),COLORGREEN;     {卖点}

{买点文字说明 - 星级和级别分两行显示}
DRAWTEXT(LEVEL_HIGH,L*0.98,' ★★★'),COLORRED;
DRAWTEXT(LEVEL_HIGH,L*0.95,'高'),COLORRED;

DRAWTEXT(LEVEL_MID,L*0.98,' ★★'),COLORYELLOW;
DRAWTEXT(LEVEL_MID,L*0.95,'中'),COLORYELLOW;

DRAWTEXT(LEVEL_LOW,L*0.98,' ★'),COLORWHITE;
DRAWTEXT(LEVEL_LOW,L*0.95,'低'),COLORWHITE;

DRAWTEXT(SELLPOINT,H*1.02,'卖出'),COLORGREEN;

{交易评估}
T_PRICE:=IF(BUYPOINT,C,IF(SELLPOINT,C,0));
PROFIT:=IF(SELLPOINT,(C-REF(T_PRICE,1))/REF(T_PRICE,1)*100,0);

{显示交易信息}
PROFITSTR:=STRCAT('收益:',VAR2STR(PROFIT,2));
DRAWTEXT_FIX(SELLPOINT,0,0.85,0,STRCAT(PROFITSTR,'%')),COLORWHITE;

{显示系统状态}
VOLSTR:=IF(VOL_GOOD,'量能良好','量能不足');
MASTR:=IF(MA_GOOD,'均线多头','均线不佳');
DRAWTEXT_FIX(BUYPOINT,0,0.80,0,VOLSTR),COLORYELLOW;
DRAWTEXT_FIX(BUYPOINT,0,0.75,0,MASTR),COLORYELLOW; 
MTR:=SUM(MAX(MAX(HIGH-LOW,ABS(HIGH-REF(CLOSE,1))),ABS(REF(CLOSE,1)-LOW)),7);

HD :=HIGH-REF(HIGH,1),NODRAW;
LD :=REF(LOW,1)-LOW,NODRAW;
DMP:=SUM(IF(HD>0&&HD>LD,HD,0),7),NODRAW;
DMM:=SUM(IF(LD>0&&LD>HD,LD,0),7),NODRAW;
PDI:=DMP*100/MTR,COLORRED,NODRAW;

MDI:=DMM*100/MTR,COLORGREEN,NODRAW;

ADX:=MA(ABS(MDI-PDI)/(MDI+PDI)*100,4),COLORBLUE,LINETHICK1,NODRAW;

买点:CROSS(PDI,MDI)  AND ADX<=35 AND PDI<=25,NODRAW;
DRAWTEXT(买点,L*0.98,'  ￥'),COLORLIMAGENTA;
DRAWTEXT(买点,L*0.96,'DMI买点'),COLORLIMAGENTA;